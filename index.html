<!DOCTYPE html>
<html lang="en">
  <head>
    <title>React Redux Lesson 2</title>
    <style>
        ol li:hover {cursor:pointer}
        ol li.completed {text-decoration: line-through}
    </style>
  </head>
  <body>
    <h1>Udacity ToDo/Goal management App</h1>
    <h2>ToDo List</h2>
    <form id="todo_form">
        <ol id="todo_list"></ol>
        <input type="text" id="todo_input" name="todo_input" placeholder="Enter new todo"/>
        <button id="addTodoBtn">Add todo</button>
    </form>
    <h2>Goals</h2>
    <ol id="goal_list"></ol>
    <form id="goal_form">
            <input type="text" id="goal_input" name="goal_input" placeholder="Enter new goal"/>
            <button id="addGoalBtn">Add goal</button>
    </form>



    <script type="text/javascript">
      // This code would be in a library
      function createStore(reducer) {
          console.log("Create Store - reducer: ", reducer);
          /**
           * this should have 4 parts:
           * 1. the state of the app - done.
           * 2. a way to get the state - done.
           * 3. a way to set/update the state
           * 4. a way to respond to/listen for changes to the state. - done
           */
          let state;

          let listeners = []; // This will contain the callback functions sent to the subscribe function whenever it is invoked

          const getState = () => state;

          const subscribe = (listener) => {
              //listener is a callback function sent when the subscribe function is set up
              // there can be an arbitrary number of listeners set up in the app.
              listeners.push(listener);

              // Now we need to return a function to the subscriber which, when invoked, will remove or 'unsubscribe'
              // this listener from list so that it is no longer notified when the state changes
              return () => {
                  console.log("removing listener %O", listener);
                  listeners = listeners.filter((l) => l !== listener);//'listener' is the callback function sent to subscribe()
              }

          }

          const dispatch = (action) => {
              //do state updates here, based up the event/action that is passed.
              //console.log("dispatch - action: ", action);
              state = reducer(state, action);

              // now loop through the current listeners list, invoking each listener function that was
              // passed in each subscribe() call.
              listeners.forEach((listener) => listener());
          }

          return {
              getState,
              subscribe,
              dispatch
          }
      }

      // Set up the various action types as variables rather than strings. If we then later have a typo, it will flag an undefined error rather than just doing nothing.
      const ADD_TODO = 'ADD_TODO';
      const DELETE_TODO = 'DELETE_TODO';
      const TOGGLE_TODO = 'TOGGLE_TODO';
      const ADD_GOAL = 'ADD_GOAL';
      const DELETE_GOAL = 'DELETE_GOAL';

      // set up functions for our various actions
      addToDoAction = (todo) => {
          return {
              type: ADD_TODO,
              todo
          }
      };

      deleteToDoAction = (id) => {
          return {
              type: DELETE_TODO,
              id
          }
      };

      toggleToDoAction = (id) => {
          return {
              type: TOGGLE_TODO,
              id
          }
      };

      addGoalAction = (goal) => {
          return {
              type: ADD_GOAL,
              goal
          }
      }

      deleteGoalAction = (id) => {
          return {
              type: DELETE_GOAL,
              id
          }
      };

      // This would be part of our app code. This is the reducer function.
      function todos (state=[], action) {
          console.log("\nTODO: ", action);
          switch (action.type) {
              case ADD_TODO:
                  return state.concat([action.todo]);
                  break;
              case DELETE_TODO:
                  return state.filter((todo) => (todo.id !== action.id));
                  break;
              case TOGGLE_TODO:
                  return state.map((todo) => todo.id !== action.id ? todo :
                      Object.assign({}, todo, {complete: !todo.complete})
                  );
                  break;
              default:
                  return state
          }
      }

      function goals (state=[], action) {
          console.log("\nGOAL: ", action);
          switch (action.type) {
              case ADD_GOAL:
                  return state.concat([action.goal]);
                  break;
              case DELETE_GOAL:
                  return state.filter((goal) => (goal.id !== action.id));
                  break;
              default:
                  return state
          }
      }

      // We only want one 'state' of the app to manage, so combine goals and todos into a single "app":
      // to avoid processing both action types in each dispatch, check to see which
      // action is being dispactched and only run the reducer for that particular action type. Otherwise
      // just return the current state for that reducer.
      function app (state={}, action) {
          return {
              todos: action.type.indexOf('TODO') >= 0 ? todos(state.todos, action) : state.todos,
              goals: action.type.indexOf('GOAL') >= 0 ? goals(state.goals, action) : state.goals
          }
      }

      const appStore = createStore(app);

      appStore.subscribe(() => {
          console.log("\napp updated: \n", appStore.getState());
      });

      console.log("appStore created. State: ", appStore.getState());

      addTodo = (evt) => {
          evt.preventDefault();
          const todo = document.getElementById('todo_input');
          const currentState = appStore.getState();
          let newId = (Math.random() + 1).toString(36).substring(7);
          const subject = todo.value;
          todo.value = ''
          console.log("addTodo. state: ", currentState, " - todo: ", todo, " - new id: ", newId);
          appStore.dispatch(addToDoAction({
              id: newId,
              subject: subject,
              complete: false
          }))
          addNewListItem('todo_list', newId, subject);
      }

    addGoal = (evt) => {
          evt.preventDefault();
          const goal = document.getElementById('goal_input');
          const currentState = appStore.getState();
          let newId = (Math.random() + 1).toString(36).substr(10);
          const subject = goal.value;
          goal.value = ''
          console.log("addGoal. state: ", currentState, " - goal: ", goal, " - new id: ", newId);
          appStore.dispatch(addGoalAction({
              id: newId,
              subject: subject,
              complete: false
          }))
          addNewListItem('goal_list', newId, subject);
      }


      document.getElementById('addTodoBtn').addEventListener('click', addTodo);
      document.getElementById('addGoalBtn').addEventListener('click', addGoal);
   
      document.getElementById("todo_list").addEventListener("click",function(e) {
        if (e.target && e.target.matches("li")) {
            e.target.className == "completed" ? e.target.className = '' : e.target.className = 'completed'; // new class name here
            appStore.dispatch(toggleToDoAction(e.target.id));
        }
      });
      
      /* this might not be needed for goals - we may want to do the delete function instead 
      document.getElementById("goal_list").addEventListener("click",function(e) {
        if (e.target && e.target.matches("li")) {
            e.target.className == "completed" ? e.target.className = '' : e.target.className = 'completed'; // new class name here
            appStore.dispatch(toggleGoalAction(e.target.id));
        }
      });
      */
      
      addNewListItem = (div_id, item_id, txt) => {
        let element = document.getElementById(div_id);
          let newItem = document.createElement("li");
          newItem.id = item_id;
          let newNode = document.createTextNode(txt);
          newItem.appendChild(newNode);
          element.appendChild(newItem);
      }
      /*
      appStore.dispatch(addToDoAction(
          {
              id: 0,
              subject: 'Finish the todo list',
              complete: false
          }
      ));

      appStore.dispatch(addToDoAction(
          {
              id: 1,
              subject: 'Add goals',
              complete: false
          }
      ));

      appStore.dispatch(addGoalAction(
          {
              id: 0,
              subject: 'Create one reducer for goals and todos?',
              complete: false
          }

      ));

      appStore.dispatch(toggleToDoAction(1));
      */

      console.log("finished");
    </script>
  </body>
</html>
