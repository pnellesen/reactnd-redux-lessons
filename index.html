<!DOCTYPE html>
<html lang="en">
  <head>
    <title>React Redux Lesson 2</title>
    <style>
        ol li.todoItem:hover, ul li span.todoItem:hover {cursor:pointer}
        ol li.completed, ul li span.completed {text-decoration: line-through}
        .loader {display: block}
        .hidden {display: none}
    </style>
    <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
    <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>


</head>
  <body>
    <h1>Udacity ToDo/Goal management App</h1>
    <div id="app"></div>

    <script type="text/javascript">

      // Set up the various action types as variables rather than strings. If we then later have a typo, it will flag an undefined error rather than just doing nothing.
      const ADD_TODO = 'ADD_TODO';
      const DELETE_TODO = 'DELETE_TODO';
      const TOGGLE_TODO = 'TOGGLE_TODO';
      const ADD_GOAL = 'ADD_GOAL';
      const DELETE_GOAL = 'DELETE_GOAL';
      const FETCH_DATA = 'FETCH_DATA';

      // set up functions for our various actions
      addToDoAction = (todo) => {
          return {
              type: ADD_TODO,
              todo
          }
      };

      deleteToDoAction = (todo) => {
          return {
              type: DELETE_TODO,
              todo
          }
      };

      toggleToDoAction = (todo) => {
          return {
              type: TOGGLE_TODO,
              todo
          }
      };

      addGoalAction = (goal) => {
          return {
              type: ADD_GOAL,
              goal
          }
      }

      deleteGoalAction = (id) => {
          return {
              type: DELETE_GOAL,
              id
          }
      };

      fetchDataAction = (todos, goals, loaderClass) => {
          return {
              type: FETCH_DATA,
              todos,
              goals,
              loaderClass
          }
      }

      // This would be part of our app code. This is the reducer function.
      function todos (state=[], action) {
          switch (action.type) {
              case ADD_TODO:
                  return state.concat([action.todo]);
                  break;
              case DELETE_TODO:
                  return state.filter((todo) => (todo.id !== action.todo.id));
                  break;
              case TOGGLE_TODO:
                  return state.map((todo) => todo.id !== action.todo.id ? (todo) : (
                      Object.assign({}, todo, {complete: !todo.complete}))
                    )
                  break;
              case FETCH_DATA:
                  return action.todos;
                  break;
              default:
                  return state
          }
      }

      function goals (state=[], action) {
          switch (action.type) {
              case ADD_GOAL:
                  return state.concat([action.goal]);
                  break;
              case DELETE_GOAL:
                  return state.filter((goal) => (goal.id !== action.id));
                  break;
              case FETCH_DATA:
                  return action.goals;
                  break;
              default:
                  return state
          }
      }

      function loaderClass (state='block', action) {
          switch (action.type) {
             case FETCH_DATA:
                return 'hidden';
            default:
                return state
          }
      }

      /**
        Now create a "checker" function which will work with Redux "applyMiddleWare" function to apply the logic to all
        our reducers
      */
      const checker = (store) => (next) => (action) => {
        // logic from our old checkAndDispatch goes here. Is the logic to
        // control whether or not we run our dispatch function
        if (action.type === ADD_TODO && action.todo.name.toLowerCase().indexOf("bitcoin") >= 0) {
            return alert("Bitcoin not allowed!");
        }
        
        if (action.type === ADD_GOAL && action.goal.name.toLowerCase().indexOf("bitcoin") >= 0) {
            return alert("Bitcoin not allowed!");
        }
        
        return next(action)// next is the next reducer in the store.
        
      }

      /**
       Add a new "middleware" called logger. This will be run by the applyMiddleware Redux function
        */
        const logger = (store) => (next) => (action) => {
            console.group(action.type)
            console.log('Action: ', action)
            const result = next(action)
            console.log('New State: ', store.getState())
            console.groupEnd()
            return result
        }

      const appStore = Redux.createStore(Redux.combineReducers({
          todos,
          goals,
          loaderClass
      }), Redux.applyMiddleware(checker, logger));//Redux is coming from the redux.min.js

      appStore.subscribe(() => {
          const { goals, todos, loaderClass } = appStore.getState();
      });

      appStore.generateId = () => (Math.random() + 1).toString(36).substring(2,12);

      console.log("appStore created. State: ", appStore.getState());

    </script>

    <script type='text/babel'>
        function Loader(props) {
            return (
                <p className={props.loaderClass}>Loading lists...</p>
            )
        }


        function List(props) {
            return (
                props.listItems.length > 0 && (
                    <ul>
                    {props.listItems.map((item) => {
                        return  <li key={item.id}><span  className={`${props.hasOwnProperty('toggleItem') && 'todoItem'} ${item.complete && 'completed'}`} onClick={() => props.toggleItem && props.toggleItem(item)}>{item.name}</span><button onClick={() => props.removeItem(item)}>X</button></li>
                    })}
                    </ul>
                )
            )
        }

    class Todos extends React.Component {
        addItem = (evt) => {
            evt.preventDefault();
            const name = this.input.value;
            this.input.value = '';
            const addResult = this.props.appStore.dispatch(addToDoAction({
                id: this.props.appStore.generateId(),
                name: name,
                complete: false
            }));
            API.saveTodo(name).catch(() =>{
                console.log("Save API failed");
                alert('Problem Saving todo - please try again in a moment');
                this.props.appStore.dispatch(deleteToDoAction(todo));
            })

        }
        removeItem = (todo) => {
           this.props.appStore.dispatch(deleteToDoAction(todo))
           API.deleteTodo(todo.id).catch(() =>{
                console.log("toggle todo API failed");
                alert('Problem updating todo - please try again in a moment');
                this.props.appStore.dispatch(addToDoAction(todo));
            })
        }
        toggleItem = (todo) => {
            this.props.appStore.dispatch(toggleToDoAction(todo));
            API.saveTodoToggle(todo.id).catch(() =>{
                console.log("toggle todo API failed");
                alert('Problem updating todo - please try again in a moment');
                this.props.appStore.dispatch(toggleToDoAction(todo));
            })
        }

        render() {

            return (
                <div>
                    <h2>Todo list here</h2>
                    <List listItems={this.props.todos} removeItem={this.removeItem} toggleItem={this.toggleItem}/>
                    <input type='text' placeholder='Enter new todo' ref={(input) => this.input = input}/>
                    <button onClick={this.addItem}>Add todo</button>
                </div>

            )
        }
    }
    /**
    * TODO: add API calls to goals
    */
    class Goals extends React.Component {
        addItem = (evt) => {
            evt.preventDefault();
            const name = this.input.value;
            this.input.value = '';
            const addResult = this.props.appStore.dispatch(addGoalAction({
                    id: this.props.appStore.generateId(),
                    name: name,
                    complete: false
                }));
        }
        removeItem = (goal) => {
           this.props.appStore.dispatch(deleteGoalAction(goal.id))
        }
        render() {
            return (
                <div>
                    <h2>Goal list here</h2>
                    <List listItems={this.props.goals} removeItem={this.removeItem}/>
                    <input type='text' placeholder='Enter new goal' ref={(input) => this.input = input}/>
                    <button onClick={this.addItem}>Add goal</button>
                </div>
            )
        }
    }


    class App extends React.Component {
        componentDidMount() {
            const { appStore } = this.props;
            appStore.subscribe(() => this.forceUpdate());// This is rarely done, but applies for this particular use case

            /*From lesson video */
            Promise.all([API.fetchTodos(), API.fetchGoals()]).then(function([todos, goals]) {
                appStore.dispatch(fetchDataAction(todos, goals));
            })
        }

        render() {
            const { appStore } = this.props;
            const { todos, goals, loaderClass } = appStore.getState();
            return (
                <div>
                <h1>New React/Redux app</h1>
                    <Loader loaderClass={loaderClass}/>
                    <Todos todos={todos} appStore={this.props.appStore}/>
                    <Goals goals={goals} appStore={this.props.appStore}/>
                </div>

            )
        }
    }

    ReactDOM.render(
        <App appStore={appStore}/>,
        document.getElementById('app')
        )
    </script>
  </body>
</html>
