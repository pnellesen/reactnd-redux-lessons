<!DOCTYPE html>
<html lang="en">
  <head>
    <title>React Redux Lesson 2</title>
    <style>
        ol li:hover {cursor:pointer}
        ol li.completed {text-decoration: line-through}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>

</head>
  <body>
    <h1>Udacity ToDo/Goal management App</h1>
    <h2>ToDo List</h2>
    <form id="todo_form">
        <ol id="todo_list"></ol>
        <input type="text" id="todo_input" name="todo_input" placeholder="Enter new todo"/>
        <button id="addTodoBtn">Add todo</button>
    </form>
    <h2>Goals</h2>
    <ol id="goal_list"></ol>
    <form id="goal_form">
            <input type="text" id="goal_input" name="goal_input" placeholder="Enter new goal"/>
            <button id="addGoalBtn">Add goal</button>
    </form>



    <script type="text/javascript">

      // Set up the various action types as variables rather than strings. If we then later have a typo, it will flag an undefined error rather than just doing nothing.
      const ADD_TODO = 'ADD_TODO';
      const DELETE_TODO = 'DELETE_TODO';
      const TOGGLE_TODO = 'TOGGLE_TODO';
      const ADD_GOAL = 'ADD_GOAL';
      const DELETE_GOAL = 'DELETE_GOAL';

      // set up functions for our various actions
      addToDoAction = (todo) => {
          return {
              type: ADD_TODO,
              todo
          }
      };

      deleteToDoAction = (id) => {
          return {
              type: DELETE_TODO,
              id
          }
      };

      toggleToDoAction = (id) => {
          return {
              type: TOGGLE_TODO,
              id
          }
      };

      addGoalAction = (goal) => {
          return {
              type: ADD_GOAL,
              goal
          }
      }

      deleteGoalAction = (id) => {
          return {
              type: DELETE_GOAL,
              id
          }
      };

      // This would be part of our app code. This is the reducer function.
      function todos (state=[], action) {
          switch (action.type) {
              case ADD_TODO:
                  return state.concat([action.todo]);
                  break;
              case DELETE_TODO:
                  return state.filter((todo) => (todo.id !== action.id));
                  break;
              case TOGGLE_TODO:
                  return state.map((todo) => todo.id !== action.id ? todo :
                      Object.assign({}, todo, {complete: !todo.complete})
                  );
                  break;
              default:
                  return state
          }
      }

      function goals (state=[], action) {
          switch (action.type) {
              case ADD_GOAL:
                  return state.concat([action.goal]);
                  break;
              case DELETE_GOAL:
                  return state.filter((goal) => (goal.id !== action.id));
                  break;
              default:
                  return state
          }
      }

      /**
        Now create a "checker" function which will work with Redux "applyMiddleWare" function to apply the logic to all
        our reducers
      */

      const checker = (store) => (next) => (action) => {
        // logic from our old checkAndDispatch goes here. Is the logic to
        // control whether or not we run our dispatch function
        if (action.type === ADD_TODO && action.todo.subject.toLowerCase().indexOf("bitcoin") >= 0) {
            return alert("Bitcoin not allowed!");
        }

        if (action.type === ADD_GOAL && action.goal.subject.toLowerCase().indexOf("bitcoin") >= 0) {
            return alert("Bitcoin not allowed!");
        }

        return next(action)// next is the next reducer in the store. 
      }

      /**
       Add a new "middleware" called logger. This will be run by the applyMiddleware Redux function
        */
        const logger = (store) => (next) => (action) => {
            console.group(action.type)
            console.log('Action: ', action)
            const result = next(action)
            console.log('New State: ', store.getState())
            console.groupEnd()
            return result
        }

      const appStore = Redux.createStore(Redux.combineReducers({
          todos,
          goals
      }), Redux.applyMiddleware(checker, logger));//Redux is coming from the redux.min.js

      appStore.subscribe(() => {
          //console.log("\napp updated: \n", appStore.getState());
      });

      console.log("appStore created. State: ", appStore.getState());

      addTodo = (evt) => {
          evt.preventDefault();
          const todo = document.getElementById('todo_input');
          let newId = (Math.random() + 1).toString(36).substring(7);
          const subject = todo.value;
          todo.value = ''
          const addResult = appStore.dispatch(addToDoAction({
              id: newId,
              subject: subject,
              complete: false
          }));
          if (addResult) addNewListItem('todo_list', newId, subject);
      }

    addGoal = (evt) => {
          evt.preventDefault();
          const goal = document.getElementById('goal_input');
          let newId = (Math.random() + 1).toString(36).substr(10);
          const subject = goal.value;
          goal.value = '';
          const addResult = appStore.dispatch(addGoalAction({
              id: newId,
              subject: subject,
              complete: false
          }));
          if (addResult) addNewListItem('goal_list', newId, subject);
      }


      document.getElementById('addTodoBtn').addEventListener('click', addTodo);
      document.getElementById('addGoalBtn').addEventListener('click', addGoal);

      document.getElementById("todo_list").addEventListener("click",function(e) {
            const thisTodo = appStore.getState().todos.find((todo) => todo.id === e.target.id);
            thisTodo ? (
                appStore.dispatch(toggleToDoAction(thisTodo.id)),
                thisTodo.complete ? e.target.className = 'none' : e.target.className = 'completed' // new class name here            
            ) : null
                
        //}
      });

      addNewListItem = (div_id, item_id, txt) => {
        let element = document.getElementById(div_id);
        let newItem = document.createElement("li");
        let newNode = document.createTextNode(txt);
        newItem.id = item_id;
        
        newItem.appendChild(newNode);
        element.appendChild(newItem);

        let deleteBtn = document.createElement("button");
        let deleteTxtNode = document.createTextNode("X");

        deleteBtn.appendChild(deleteTxtNode);
        newItem.appendChild(deleteBtn);

        deleteBtn.addEventListener('click', (e) => {
            e.preventDefault();
            div_id.indexOf('todo') >= 0 ? appStore.dispatch(deleteToDoAction(item_id)) : appStore.dispatch(deleteGoalAction(item_id));
            element.removeChild(newItem);
        });
      }

      console.log("app initialized");
    </script>
  </body>
</html>
